{"version":3,"sources":["QueryDocuments/QueryContainerProperty.ts"],"names":[],"mappings":"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","file":"QueryContainerProperty.js","sourcesContent":["import {\n\tIRIToken,\n\tLimitToken,\n\tLiteralToken,\n\tObjectToken,\n\tOffsetToken,\n\tOrderToken,\n\tPatternToken,\n\tPropertyToken,\n\tSubjectToken,\n\tSubSelectToken,\n\tVariableToken\n} from \"sparqler/tokens\";\n\nimport { IllegalArgumentError } from \"../Errors/IllegalArgumentError\";\nimport { IllegalStateError } from \"../Errors/IllegalStateError\";\n\nimport { DigestedObjectSchemaProperty } from \"../ObjectSchema/DigestedObjectSchemaProperty\";\n\nimport { LDP } from \"../Vocabularies/LDP\";\n\nimport { QueryContainer } from \"./QueryContainer\";\nimport { QueryContainerPropertyType } from \"./QueryContainerPropertyType\";\nimport { QueryDocumentsOrder } from \"./QueryDocumentsOrder\";\nimport { QueryProperty } from \"./QueryProperty\";\nimport { QueryPropertyType } from \"./QueryPropertyType\";\n\n\n/**\n * Base data for a {@link QueryContainerProperty} creation.\n */\nexport interface QueryContainerPropertyData {\n\tqueryContainer:QueryContainer;\n\n\tcontainerIRI:IRIToken;\n\tcontainerPropertyType:QueryContainerPropertyType;\n}\n\n/**\n * Property that defines a retrieval mode of a container.\n * This retrieval can be made for `children` or `members`.\n */\nexport class QueryContainerProperty extends QueryProperty {\n\treadonly parent:undefined;\n\n\treadonly containerIRI:IRIToken;\n\treadonly containerPropertyType:QueryContainerPropertyType;\n\n\torder?:QueryDocumentsOrder;\n\tprotected _limit?:number;\n\tprotected _offset?:number;\n\n\tconstructor( data:QueryContainerPropertyData ) {\n\t\tsuper( {\n\t\t\tqueryContainer: data.queryContainer,\n\t\t\tname: data.containerPropertyType,\n\n\t\t\tdefinition: new DigestedObjectSchemaProperty(),\n\n\t\t\toptional: false,\n\t\t\tpropertyType: QueryPropertyType.PARTIAL,\n\t\t} );\n\n\t\tthis.containerIRI = data.containerIRI;\n\t\tthis.containerPropertyType = data.containerPropertyType;\n\t}\n\n\n\tprotected __createSelfPattern():PatternToken | undefined {\n\t\tconst subSelect:SubSelectToken = new SubSelectToken( \"DISTINCT\" )\n\t\t\t.addVariable( this.variable );\n\n\t\tswitch( this.containerPropertyType ) {\n\t\t\tcase QueryContainerPropertyType.CHILD:\n\t\t\t\tsubSelect.addPattern( this.__createChildSelfPattern() );\n\t\t\t\tbreak;\n\n\t\t\tcase QueryContainerPropertyType.MEMBER:\n\t\t\t\tsubSelect.addPattern( ...this.__createMemberSelfPattern() );\n\t\t\t\tbreak;\n\n\t\t\tdefault:\n\t\t\t\tthrow new IllegalStateError( `Invalid container type.` );\n\t\t}\n\n\t\t// Add non-optional properties that may affect pagination\n\t\tconst valuedPatterns:PatternToken[] | undefined = this.__getValuedPatterns();\n\t\tif( valuedPatterns ) subSelect.addPattern( ...valuedPatterns );\n\n\n\t\tthis.__addOrderTo( subSelect );\n\t\tthis.__addLimitTo( subSelect );\n\t\tthis.__addOffsetTo( subSelect );\n\n\t\treturn subSelect;\n\t}\n\n\tprotected __createChildSelfPattern():PatternToken {\n\t\treturn new SubjectToken( this.containerIRI )\n\t\t\t.addProperty( new PropertyToken( this.queryContainer.compactIRI( LDP.contains ) )\n\t\t\t\t.addObject( this.identifier )\n\t\t\t);\n\t}\n\n\tprotected __createMemberSelfPattern():PatternToken[] {\n\t\tconst membershipResource:VariableToken = this.queryContainer.getVariable( \"membershipResource\" );\n\t\tconst hasMemberRelation:VariableToken = this.queryContainer.getVariable( \"hasMemberRelation\" );\n\n\t\tconst memberRelations:PatternToken = new SubSelectToken()\n\t\t\t.addVariable( membershipResource, hasMemberRelation )\n\t\t\t.addPattern( new SubjectToken( this.containerIRI )\n\t\t\t\t.addProperty( new PropertyToken( this.queryContainer.compactIRI( LDP.membershipResource ) )\n\t\t\t\t\t.addObject( membershipResource )\n\t\t\t\t)\n\t\t\t\t.addProperty( new PropertyToken( this.queryContainer.compactIRI( LDP.hasMemberRelation ) )\n\t\t\t\t\t.addObject( hasMemberRelation )\n\t\t\t\t)\n\t\t\t);\n\n\t\tconst memberSelection:PatternToken = new SubjectToken( membershipResource )\n\t\t\t.addProperty( new PropertyToken( hasMemberRelation )\n\t\t\t\t.addObject( this.identifier )\n\t\t\t);\n\n\t\treturn [ memberRelations, memberSelection ];\n\t}\n\n\tprotected __addLimitTo( subSelect:SubSelectToken ):void {\n\t\tif( this._limit === void 0 ) return;\n\n\t\tsubSelect.addModifier( new LimitToken( this._limit ) );\n\t}\n\n\tprotected __addOffsetTo( subSelect:SubSelectToken ):void {\n\t\tif( this._offset === void 0 ) return;\n\t\tsubSelect.addModifier( new OffsetToken( this._offset ) );\n\t}\n\n\tprotected __addOrderTo( subSelect:SubSelectToken ):void {\n\t\tif( ! this.order ) return;\n\n\t\tconst targetProperty:QueryProperty | undefined = this.getProperty( this.order.path, { create: true } );\n\t\tif( ! targetProperty ) throw new IllegalArgumentError( `Property \"${this.order.path}\" hasn't been defined.` );\n\n\t\tconst identifier:VariableToken | IRIToken | LiteralToken = targetProperty.identifier;\n\t\tconst constraint:VariableToken | string = identifier.token === \"variable\"\n\t\t\t? identifier\n\t\t\t: `( ${identifier} )`;\n\n\t\t// Add modifier\n\t\tsubSelect.addModifier( new OrderToken( constraint, this.order.flow ) );\n\n\t\tconst orderPatterns:PatternToken[] = this.__createSubPatternsFrom( targetProperty );\n\t\t// Add patterns to the sub-select that do not exists\n\t\torderPatterns\n\t\t\t.filter( pattern => {\n\t\t\t\tif( pattern.token !== \"subject\" ) return true;\n\n\t\t\t\tconst targetSubject:SubjectToken | undefined = subSelect\n\t\t\t\t\t.where.groupPattern.patterns\n\t\t\t\t\t.find( ( selectPattern ):selectPattern is SubjectToken => {\n\t\t\t\t\t\tif( selectPattern.token !== \"subject\" ) return false;\n\t\t\t\t\t\treturn selectPattern.subject === pattern.subject;\n\t\t\t\t\t} );\n\n\t\t\t\tif( ! targetSubject ) return true;\n\n\t\t\t\tpattern.properties.forEach( property => {\n\t\t\t\t\tconst targetPredicate:PropertyToken | undefined = targetSubject\n\t\t\t\t\t\t.properties\n\t\t\t\t\t\t.find( ( selectProperty ) => {\n\t\t\t\t\t\t\treturn property.toString() === selectProperty.toString();\n\t\t\t\t\t\t} );\n\n\t\t\t\t\tif( ! targetPredicate )\n\t\t\t\t\t\ttargetSubject.addProperty( property );\n\n\t\t\t\t\tproperty.objects.forEach( object => {\n\t\t\t\t\t\tconst targetObject:ObjectToken | undefined = targetPredicate!\n\t\t\t\t\t\t\t.objects\n\t\t\t\t\t\t\t.find( ( selectObject ) => {\n\t\t\t\t\t\t\t\treturn selectObject.toString() === object.toString();\n\t\t\t\t\t\t\t} );\n\n\t\t\t\t\t\tif( ! targetObject )\n\t\t\t\t\t\t\ttargetPredicate!.addObject( object );\n\t\t\t\t\t} );\n\t\t\t\t} );\n\t\t\t} )\n\t\t\t.forEach( pattern => {\n\t\t\t\tsubSelect.addPattern( pattern );\n\t\t\t} )\n\t\t;\n\t}\n\n\tprotected __createSubPatternsFrom( targetProperty:QueryProperty ):PatternToken[] {\n\t\tlet matchPatterns:PatternToken[] = [];\n\n\t\t// While not been the root property\n\t\twhile( targetProperty !== this ) {\n\t\t\tconst subTargetPattern:PatternToken | undefined = targetProperty.getSelfPattern()!;\n\n\t\t\t// Append non optional\n\t\t\tif( subTargetPattern.token !== \"optional\" ) {\n\t\t\t\tmatchPatterns.unshift( subTargetPattern );\n\n\t\t\t\t// Added as sub-pattern of the optional\n\t\t\t} else {\n\t\t\t\tmatchPatterns = [\n\t\t\t\t\tsubTargetPattern\n\t\t\t\t\t\t.addPattern( ...matchPatterns ),\n\t\t\t\t];\n\t\t\t}\n\n\t\t\tif( ! targetProperty.parent ) break;\n\t\t\ttargetProperty = targetProperty.parent;\n\t\t}\n\n\t\treturn matchPatterns;\n\t}\n\n\n\t// Override to be added in the sub-select\n\tprotected __addTypesTo( pattern:SubjectToken ):void {}\n\n\n\t/**\n\t * Sets the order for the sub-select of the contained resources.\n\t * @param order Object with the order specification.\n\t */\n\tsetOrder( order:QueryDocumentsOrder ):void {\n\t\tthis.order = order;\n\t}\n\n\t/**\n\t * Sets the limit for the sub-select of the contained resources.\n\t * @param limit The limit to set.\n\t */\n\tsetLimit( limit:number ):void {\n\t\tthis._limit = limit;\n\t}\n\n\t/**\n\t * Sets the offset for the sub-select of the contained resources.\n\t * @param offset The offset to set.\n\t */\n\tsetOffset( offset:number ):void {\n\t\tthis._offset = offset;\n\t}\n}\n"],"sourceRoot":"../../src"}