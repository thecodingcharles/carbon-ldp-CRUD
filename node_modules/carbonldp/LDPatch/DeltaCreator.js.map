{"version":3,"sources":["LDPatch/DeltaCreator.ts"],"names":[],"mappings":"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","file":"DeltaCreator.js","sourcesContent":["import { isBNodeLabel } from \"sparqler/iri\";\nimport {\n\tBlankNodeToken,\n\tCollectionToken,\n\tIRIRefToken,\n\tIRIToken,\n\tLanguageToken,\n\tLiteralToken,\n\tObjectToken,\n\tPathToken,\n\tPrefixedNameToken,\n\tPropertyToken,\n\tRDFLiteralToken,\n\tSubjectToken,\n} from \"sparqler/tokens\";\n\nimport { Context } from \"../Context/Context\";\n\nimport { _guessXSDType } from \"../JSONLD/Utils\";\n\nimport { ContainerType } from \"../ObjectSchema/ContainerType\";\nimport { DigestedObjectSchema } from \"../ObjectSchema/DigestedObjectSchema\";\nimport { DigestedObjectSchemaProperty } from \"../ObjectSchema/DigestedObjectSchemaProperty\";\nimport { ObjectSchemaDigester } from \"../ObjectSchema/ObjectSchemaDigester\";\nimport { PointerType } from \"../ObjectSchema/PointerType\";\n\nimport { Pointer } from \"../Pointer/Pointer\";\n\nimport { QueryablePointer } from \"../QueryDocuments/QueryablePointer\";\nimport { QueryableProperty } from \"../QueryDocuments/QueryableProperty\";\n\nimport { Resource } from \"../Resource/Resource\";\n\nimport { _isExistingValue, isString } from \"../Utils\";\n\nimport { XSD } from \"../Vocabularies/XSD\";\n\nimport { AddToken, DeleteToken, LDPatchToken, PrefixToken, SliceToken, UpdateListToken } from \"./Tokens\";\n\n\ninterface ArrayDelta {\n\ttoAdd:ObjectToken[];\n\ttoDelete:ObjectToken[];\n}\n\ninterface UpdateDelta {\n\tslice:[ number | undefined, number | undefined ];\n\tobjects:ObjectToken[];\n}\n\nconst typesDefinition:DigestedObjectSchemaProperty = new DigestedObjectSchemaProperty();\ntypesDefinition.literal = false;\ntypesDefinition.pointerType = PointerType.ID;\ntypesDefinition.containerType = ContainerType.SET;\n\n\ntype TargetResource = Partial<Pick<Resource, \"types\"> & Pick<QueryablePointer, \"$_queryableMetadata\">>;\n\n\n/**\n * Creates a LD Patch delta for the resources provided.\n */\nexport class DeltaCreator {\n\n\tprivate prefixesMap:Map<string, PrefixToken>;\n\tprivate context:Context;\n\n\tprivate readonly addToken:AddToken;\n\tprivate readonly deleteToken:DeleteToken;\n\tprivate readonly updateLists:UpdateListToken[];\n\n\t/**\n\t * Creates the instant with the provided context as the addition data source.\n\t * @param context The context of the resources to create its LD Patch delta.\n\t */\n\tconstructor( context:Context ) {\n\t\tthis.prefixesMap = new Map();\n\t\tthis.context = context;\n\n\t\tthis.addToken = new AddToken();\n\t\tthis.deleteToken = new DeleteToken();\n\t\tthis.updateLists = [];\n\t}\n\n\t/**\n\t * Returns the LD Patch string of the resources set in {@link DeltaCreator.addResource()}.\n\t */\n\tgetPatch():string {\n\t\tconst patch:LDPatchToken = new LDPatchToken();\n\n\t\tthis.prefixesMap.forEach( prefix => patch.prologues.push( prefix ) );\n\n\t\tpatch.statements.push( ...this.updateLists );\n\t\tif( this.addToken.triples.length ) patch.statements.push( this.addToken );\n\t\tif( this.deleteToken.triples.length ) patch.statements.push( this.deleteToken );\n\n\t\treturn `${patch}`;\n\t}\n\n\t/**\n\t * Add the resources states ({@param previousResource} and {@param currentResource}) from where to create the delta.\n\t * @param id The URI of the resource been added.\n\t * @param previousResource The previous state of the resource to compare for its delta.\n\t * @param currentResource The current state of the resource to compare for its delta.\n\t */\n\taddResource( id:string, previousResource:object, currentResource:object ):void {\n\t\tconst schema:DigestedObjectSchema = this.__getSchema( id, previousResource, currentResource );\n\n\t\tconst resource:IRIToken | BlankNodeToken = isBNodeLabel( id ) ?\n\t\t\tnew BlankNodeToken( id ) : this.__compactIRI( schema, id );\n\n\t\tconst updateLists:UpdateListToken[] = [];\n\t\tconst addTriples:SubjectToken = new SubjectToken( resource );\n\t\tconst deleteTriples:SubjectToken = new SubjectToken( resource );\n\n\t\tnew Set( [\n\t\t\t\"types\",\n\t\t\t...Object.keys( previousResource ),\n\t\t\t...Object.keys( currentResource ),\n\t\t] ).forEach( propertyName => {\n\t\t\tif( propertyName === \"$id\" ) return;\n\n\t\t\tconst predicateURI:IRIToken | \"a\" = propertyName === \"types\" ?\n\t\t\t\t\"a\" : this._getPropertyIRI( schema, propertyName );\n\n\t\t\tconst definition:DigestedObjectSchemaProperty | undefined = predicateURI === \"a\" ?\n\t\t\t\ttypesDefinition : schema.getProperty( propertyName );\n\n\t\t\tconst oldValue:any = previousResource[ propertyName ];\n\t\t\tconst newValue:any = currentResource[ propertyName ];\n\n\t\t\tif( definition && definition.containerType === ContainerType.LIST && _isExistingValue( oldValue ) ) {\n\t\t\t\tconst listUpdates:UpdateDelta[] = [];\n\n\t\t\t\tif( ! _isExistingValue( newValue ) ) {\n\t\t\t\t\tdeleteTriples.addProperty( new PropertyToken( predicateURI ).addObject( new CollectionToken() ) );\n\t\t\t\t\tlistUpdates.push( { slice: [ 0, void 0 ], objects: [] } );\n\n\t\t\t\t} else {\n\t\t\t\t\tdefinition.containerType = ContainerType.SET;\n\n\t\t\t\t\tlistUpdates.push( ...__getListDelta(\n\t\t\t\t\t\tthis.__getObjects( oldValue, schema, definition ),\n\t\t\t\t\t\tthis.__getObjects( newValue, schema, definition )\n\t\t\t\t\t) );\n\t\t\t\t}\n\n\t\t\t\tif( ! listUpdates.length ) return;\n\n\t\t\t\tthis.__addPrefixFrom( predicateURI, schema );\n\t\t\t\tlistUpdates.forEach( updateDelta => {\n\t\t\t\t\tconst collection:CollectionToken = new CollectionToken();\n\n\t\t\t\t\tupdateDelta.objects.forEach( object => {\n\t\t\t\t\t\tcollection.addObject( object );\n\t\t\t\t\t\tthis.__addPrefixFrom( object, schema );\n\t\t\t\t\t} );\n\n\t\t\t\t\tupdateLists.push( new UpdateListToken(\n\t\t\t\t\t\tresource,\n\t\t\t\t\t\tpredicateURI as IRIToken,\n\t\t\t\t\t\tupdateDelta.objects.length ?\n\t\t\t\t\t\t\tnew SliceToken( updateDelta.slice[ 0 ], updateDelta.slice[ 0 ] ) :\n\t\t\t\t\t\t\tnew SliceToken( ...updateDelta.slice ),\n\t\t\t\t\t\tcollection\n\t\t\t\t\t) );\n\t\t\t\t} );\n\n\t\t\t} else {\n\t\t\t\tconst oldObjects:ObjectToken[] = this.__getObjects( oldValue, schema, definition );\n\t\t\t\tconst newObjects:ObjectToken[] = this.__getObjects( newValue, schema, definition );\n\n\t\t\t\tconst setDelta:ArrayDelta = __getArrayDelta( oldObjects, newObjects );\n\n\t\t\t\tconst addValues:( objects:ObjectToken[], triple:SubjectToken ) => void = ( objects, triple ) => {\n\t\t\t\t\tif( ! objects.length ) return;\n\n\t\t\t\t\tconst property:PropertyToken = new PropertyToken( predicateURI );\n\t\t\t\t\tobjects.forEach( object => {\n\t\t\t\t\t\tproperty.addObject( object );\n\t\t\t\t\t\tthis.__addPrefixFrom( object, schema );\n\t\t\t\t\t} );\n\n\t\t\t\t\ttriple.addProperty( property );\n\t\t\t\t};\n\n\t\t\t\taddValues( setDelta.toAdd, addTriples );\n\t\t\t\taddValues( setDelta.toDelete, deleteTriples );\n\t\t\t}\n\t\t} );\n\n\t\tthis.updateLists.push( ...updateLists );\n\t\tupdateLists.forEach( x => this.__addPrefixFrom( x.predicate, schema ) );\n\n\t\tif( addTriples.properties.length ) this.addToken.triples.push( addTriples );\n\t\taddTriples.properties.forEach( x => this.__addPrefixFrom( x.verb, schema ) );\n\n\t\tif( deleteTriples.properties.length ) this.deleteToken.triples.push( deleteTriples );\n\t\tdeleteTriples.properties.forEach( x => this.__addPrefixFrom( x.verb, schema ) );\n\n\t\tthis.__addPrefixFrom( resource, schema );\n\t}\n\n\tprivate __getSchema( $id:string, previousResource:TargetResource, currentResource:TargetResource ):DigestedObjectSchema {\n\t\tconst typesSet:Set<string> = new Set();\n\n\t\tif( \"types\" in previousResource ) previousResource\n\t\t\t.types!.forEach( typesSet.add, typesSet );\n\t\tif( \"types\" in currentResource ) currentResource\n\t\t\t.types!.forEach( typesSet.add, typesSet );\n\n\n\t\tconst mergedResource:object = { $id, types: Array.from( typesSet ) };\n\t\tconst baseSchema:DigestedObjectSchema = this.context.registry\n\t\t\t.getSchemaFor( mergedResource );\n\n\t\tconst queryableProperty:QueryableProperty | undefined = previousResource.$_queryableMetadata || previousResource.$_queryableMetadata;\n\t\tif( ! queryableProperty ) return baseSchema;\n\n\t\treturn ObjectSchemaDigester._combineSchemas( [\n\t\t\tbaseSchema,\n\t\t\tqueryableProperty.getSchema(),\n\t\t] );\n\t}\n\n\tprivate _getPropertyIRI( schema:DigestedObjectSchema, propertyName:string ):IRIToken {\n\t\tconst propertyDefinition:DigestedObjectSchemaProperty | undefined = schema.properties.get( propertyName );\n\t\tconst uri:string = propertyDefinition && propertyDefinition.uri ?\n\t\t\tpropertyDefinition.uri :\n\t\t\tpropertyName;\n\n\t\treturn this.__compactIRI( schema, uri );\n\t}\n\n\tprivate __getObjects( value:any, schema:DigestedObjectSchema, definition?:DigestedObjectSchemaProperty ):ObjectToken[] {\n\t\tconst values:any[] = (Array.isArray( value ) ?\n\t\t\t\t! definition || definition.containerType !== null ? value : value.slice( 0, 1 ) :\n\t\t\t\t[ value ]\n\t\t).filter( _isExistingValue );\n\n\t\tif( definition && definition.containerType === ContainerType.LIST ) {\n\t\t\tif( ! _isExistingValue( value ) ) return [];\n\n\t\t\tconst collection:CollectionToken = new CollectionToken();\n\t\t\tcollection.objects.push( ...this.__expandValues( values, schema, definition ) );\n\n\t\t\treturn [ collection ];\n\t\t}\n\n\t\tif( definition && definition.containerType === ContainerType.LANGUAGE ) {\n\t\t\treturn this.__expandLanguageMap( values, schema );\n\t\t}\n\n\t\treturn this.__expandValues( values, schema, definition );\n\t}\n\n\tprivate __expandValues( values:any[], schema:DigestedObjectSchema, definition?:DigestedObjectSchemaProperty ):ObjectToken[] {\n\t\tconst areDefinedLiteral:boolean | null = definition && definition.literal !== null ? definition.literal : null;\n\n\t\treturn values\n\t\t\t.map( value => {\n\t\t\t\tconst isLiteral:boolean = areDefinedLiteral !== null ? areDefinedLiteral : ! Pointer.is( value );\n\n\t\t\t\tif( isLiteral ) return this.__expandLiteral( value, schema, definition );\n\t\t\t\treturn this.__expandPointer( value, schema );\n\t\t\t} )\n\t\t\t.filter( _isExistingValue );\n\t}\n\n\tprivate __expandLanguageMap( values:any[], schema:DigestedObjectSchema ):ObjectToken[] {\n\t\tif( ! values.length ) return [];\n\t\tconst languageMap:object = values[ 0 ];\n\n\t\treturn Object\n\t\t\t.keys( languageMap )\n\t\t\t.map( key => {\n\t\t\t\tconst value:any = languageMap[ key ];\n\n\t\t\t\tconst tempDefinition:DigestedObjectSchemaProperty = new DigestedObjectSchemaProperty();\n\t\t\t\ttempDefinition.language = key;\n\t\t\t\ttempDefinition.literalType = XSD.string;\n\n\t\t\t\treturn this.__expandLiteral( value, schema, tempDefinition );\n\t\t\t} )\n\t\t\t.filter( _isExistingValue );\n\t}\n\n\tprivate __expandPointer( value:any, schema:DigestedObjectSchema ):IRIToken | BlankNodeToken | null {\n\t\tconst id:string = Pointer.is( value ) ? value.$id : value;\n\t\tif( ! isString( id ) ) return null;\n\n\t\treturn isBNodeLabel( id ) ?\n\t\t\tnew BlankNodeToken( id ) :\n\t\t\tthis.__compactIRI( schema, id );\n\t}\n\n\tprivate __expandLiteral( value:any, schema:DigestedObjectSchema, definition?:DigestedObjectSchemaProperty ):LiteralToken | null {\n\t\tconst type:string | null = definition && definition.literalType ?\n\t\t\tdefinition.literalType :\n\t\t\t_guessXSDType( value );\n\n\t\tif( type === null || ! this.context.jsonldConverter.literalSerializers.has( type ) ) return null;\n\n\t\tvalue = this.context.jsonldConverter.literalSerializers.get( type )!.serialize( value );\n\t\tif( type !== XSD.string )\n\t\t\treturn new RDFLiteralToken( value, this.__compactIRI( schema, type ) );\n\n\t\tif( definition && typeof definition.language === \"string\" )\n\t\t\treturn new RDFLiteralToken( value, new LanguageToken( definition.language ) );\n\n\t\treturn new LiteralToken( value );\n\t}\n\n\tprivate __compactIRI( schema:DigestedObjectSchema, iri:string ):IRIToken {\n\t\tiri = schema.resolveURI( iri, { vocab: true } );\n\n\t\tconst matchPrefix:[ string, string ] | undefined = Array.from( schema.prefixes.entries() )\n\t\t\t.find( ( [ , prefixURI ] ) => iri.startsWith( prefixURI ) );\n\n\t\tif( ! matchPrefix ) return new IRIRefToken( iri );\n\n\t\treturn new PrefixedNameToken( matchPrefix[ 0 ], iri.substr( matchPrefix[ 1 ].length ) );\n\t}\n\n\tprivate __addPrefixFrom( object:ObjectToken | PathToken, schema:DigestedObjectSchema ):void {\n\t\tif( object === \"a\" ) return;\n\n\t\tif( \"objects\" in object )\n\t\t\treturn object.objects.forEach( collectionObject => {\n\t\t\t\tthis.__addPrefixFrom( collectionObject, schema );\n\t\t\t} );\n\n\t\tif( \"type\" in object )\n\t\t\treturn this.__addPrefixFrom( object.type!, schema );\n\n\t\tif( object.token !== \"prefixedName\" ) return;\n\n\t\tconst namespace:string = object.namespace;\n\t\tif( this.prefixesMap.has( namespace ) ) return;\n\n\t\tconst iri:string = schema.prefixes.get( namespace )!;\n\t\tthis.prefixesMap.set( namespace, new PrefixToken( namespace, new IRIRefToken( iri ) ) );\n\t}\n\n}\n\nfunction __getArrayDelta( oldValues:ObjectToken[], newValues:ObjectToken[] ):ArrayDelta {\n\tconst objectMapper:( object:ObjectToken ) => [ string, ObjectToken ] = object => [ `${object}`, object ];\n\tconst toAdd:Map<string, ObjectToken> = new Map( newValues.map( objectMapper ) );\n\tconst toDelete:Map<string, ObjectToken> = new Map( oldValues.map( objectMapper ) );\n\n\ttoAdd.forEach( ( value, identifier ) => {\n\t\tif( ! toDelete.has( identifier ) ) return;\n\n\t\ttoDelete.delete( identifier );\n\t\ttoAdd.delete( identifier );\n\t} );\n\n\treturn {\n\t\ttoAdd: Array.from( toAdd.values() ),\n\t\ttoDelete: Array.from( toDelete.values() ),\n\t};\n}\n\nfunction __getListDelta( oldValues:ObjectToken[], newValues:ObjectToken[] ):UpdateDelta[] {\n\tinterface Node {\n\t\tidentifier:string;\n\t\tobject:ObjectToken;\n\t\tindex:number;\n\t}\n\n\tconst nodeMapper:( object:ObjectToken, index:number ) => Node = ( object, index ) => ({\n\t\tidentifier: `${object}`,\n\t\tobject,\n\t\tindex,\n\t});\n\tconst oldPositions:Node[] = oldValues.map( nodeMapper );\n\tconst newPositions:Node[] = newValues.map( nodeMapper );\n\n\tconst addsSet:Set<Node> = new Set( newPositions );\n\tconst deletes:Node[] = [];\n\n\tlet offset:number = 0;\n\tlet remnants:Node[] = newPositions;\n\n\toldPositions.forEach( oldNode => {\n\t\tconst currentIndex:number = remnants.findIndex( newNode => newNode.identifier === oldNode.identifier );\n\n\t\tif( currentIndex === - 1 ) {\n\t\t\toldNode.index -= offset ++;\n\t\t\tdeletes.push( oldNode );\n\t\t} else {\n\t\t\taddsSet.delete( remnants[ currentIndex ] );\n\t\t\tremnants = remnants.slice( currentIndex + 1 );\n\t\t}\n\t} );\n\n\tconst updates:UpdateDelta[] = [];\n\n\tlet last:UpdateDelta | undefined;\n\tdeletes.forEach( node => {\n\t\tif( last && last.slice[ 0 ] === node.index ) {\n\t\t\tlast.slice = [ last.slice[ 0 ], last.slice[ 1 ]! + 1 ];\n\t\t\treturn;\n\t\t}\n\n\t\tupdates.push( last = {\n\t\t\tslice: [ node.index, node.index + 1 ],\n\t\t\tobjects: [],\n\t\t} );\n\t} );\n\n\tlast = void 0;\n\taddsSet.forEach( node => {\n\t\tif( last && last.slice[ 1 ] === node.index ) {\n\t\t\tlast.slice = [ last.slice[ 0 ], node.index + 1 ];\n\t\t\tlast.objects.push( node.object );\n\t\t\treturn;\n\t\t}\n\n\t\tupdates.push( last = {\n\t\t\tslice: [ node.index, node.index + 1 ],\n\t\t\tobjects: [ node.object ],\n\t\t} );\n\t} );\n\n\treturn updates;\n}\n"],"sourceRoot":"../../src"}